# /nginx.conf
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    # 【核心配置】定义限流区域
    # zone=perip:10m: 创建一个名为 perip 的10MB内存区域
    # rate=5r/s:      允许来自同一个IP的平均请求速率为每秒5个
    limit_req_zone $binary_remote_addr zone=perip:10m rate=5r/s;

    server {
        listen 80;
        server_name localhost;

        location / {
            # 【核心配置】应用限流规则
            # burst=10:  允许的突发请求数（“令牌桶”的容量）
            # nodelay:   超出限制的请求立即返回 503，不排队
            limit_req zone=perip burst=10 nodelay;

            # 【核心配置】将请求反向代理到你的主机
            # 使用 host.docker.internal 来指向你的电脑
            proxy_pass http://host.docker.internal:8080;

            # ------ 以下是标准的代理头信息设置 ------
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}